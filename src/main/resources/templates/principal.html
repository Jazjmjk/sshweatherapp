<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Clima - Vista Principal</title>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="300">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            background: #f0f4f7;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            background: #b68b00;
            color: #fff;
            padding: 20px;
            text-align: left;
            border-bottom: 4px solid #155fa0;
        }
        header h1 {
            margin: 0;
            font-size: 20px;
            text-transform: uppercase;
        }
        header h2 {
            margin: 0;
            font-size: 16px;
            font-weight: normal;
        }
        nav {
            background: #155fa0;
            display: flex;
            padding: 10px;
        }
        nav .tab {
            color: #fff;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            transition: background 0.3s;
        }
        nav .tab:hover {
            background: #0f4d87;
        }
        nav .tab.active {
            background: #fff;
            color: #155fa0;
            border-radius: 5px 5px 0 0;
        }

        main {
            flex: 1;
        }

        .tab-content {
            display: none;
            padding: 30px;
            background: #fff;
            border-radius: 0 0 10px 10px;
            margin: 0 10px 20px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #Inicio .panel {
            background: #fefefe;
            border-radius: 10px;
            padding: 20px 40px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        #Inicio .panel h2 {
            text-align: center;
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }
        #Inicio .panel .fecha,
        #Inicio .panel .hora {
            text-align: center;
            color: #666;
            font-size: 18px;
            margin-bottom: 10px;
        }
        #Inicio .panel .main-weather {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 25px;
            color: #444;
        }
        #Inicio .panel .data-boxes {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 30px;
        }
        #Inicio .panel .data-box {
            background: #f0f4f7;
            border-radius: 15px;
            padding: 20px 30px;
            min-width: 180px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            transform: translateY(0);
            font-size: 16px;
        }
        #Inicio .panel .data-box strong {
            font-size: 18px;
            color: #222;
            display: block;
            margin-bottom: 8px;
        }
        #Inicio .panel .data-box span {
            font-size: 16px;
            color: #555;
        }
        #Inicio .panel .data-box .aqi-text {
            font-weight: bold;
            font-size: 18px;
        }
        .aqi-bueno { color: #28a745; }
        .aqi-regular { color: #ffc107; }
        .aqi-malo { color: #dc3545; }

        #Reporte #reporte-estaciones-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        #Reporte .panel {
            background: #fefefe;
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            font-size: 14px;
            flex: 1;
            min-width: 350px;
            max-width: 450px;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #Reporte .panel h2 {
            text-align: center;
            color: #333;
            font-size: 18px;
            margin-bottom: 8px;
        }

        #Reporte .panel .fecha,
        #Reporte .panel .hora {
            text-align: center;
            color: #666;
            font-size: 13px;
            margin-bottom: 5px;
        }

        #Reporte .panel .hora {
            margin-bottom: 12px;
        }

        #Reporte .panel .main-weather {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #444;
        }

        #Reporte .panel .data-boxes {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
            flex-grow: 1;
        }

        #Reporte .panel .data-box {
            background: #f0f4f7;
            border-radius: 8px;
            padding: 8px 12px;
            min-width: 100px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            font-size: 12px;
            flex: 1;
        }

        #Reporte .panel .data-box strong {
            font-size: 12px;
            color: #222;
            display: block;
            margin-bottom: 4px;
        }

        #Reporte .panel .data-box span {
            font-size: 12px;
            color: #555;
        }

        .status-indicator {
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            margin-bottom: 8px;
        }
        .status-activa { color: green; }
        .status-inactiva { color: red; }

        .btn-group {
            text-align: center;
            margin-top: auto;
            padding-top: 10px;
        }

        .btn {
            background-color: #155fa0;
            color: white;
            border: none;
            padding: 6px 12px;
            margin: 3px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn:hover:not(:disabled) {
            background-color: #0f4d87;
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #Estaciones .panel {
            background: #fefefe;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
        }

        #Estaciones .panel h2 {
            text-align: center;
            color: #333;
            font-size: 28px;
            margin-bottom: 20px;
        }

        #map {
            height: 600px;
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .map-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .map-info h3 {
            color: #155fa0;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .station-legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.active {
            background-color: #28a745;
        }

        .legend-dot.inactive {
            background-color: #dc3545;
        }

        #modalReporte, #modalDescargar {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            overflow-y: auto;
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            margin: 60px auto;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .modal-header h3 {
            margin: 0;
            font-weight: 600;
            font-size: 22px;
            color: #333;
        }
        .close-btn {
            cursor: pointer;
            font-size: 28px;
            font-weight: bold;
            color: #999;
            transition: color 0.3s;
            border: none;
            background: transparent;
            line-height: 1;
        }
        .close-btn:hover {
            color: #444;
        }

        canvas {
            width: 100% !important;
            max-width: 700px !important;
            height: 300px !important;
            display: block;
            margin: 10px auto;
            background: #f9f9f9;
            border-radius: 10px;
        }

        .download-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fff;
            border-radius: 10px;
            padding: 20px 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 2000;
            display: none;
            border-left: 8px solid #155fa0;
            min-width: 250px;
            animation: slideIn 0.3s ease-out;
        }

        .download-notification.success {
            border-left-color: #28a745;
        }

        .download-notification .notification-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .download-notification .notification-icon {
            font-size: 28px;
        }

        .download-notification .notification-text {
            font-weight: 600;
            color: #333;
            font-size: 18px;
        }

        .spinner {
            width: 25px;
            height: 25px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #155fa0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        footer {
            background: #2c5282;
            color: white;
            padding: 20px;
            margin-top: auto;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .footer-left {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .footer-info h3 {
            margin: 0 0 5px 0;
            font-size: 14px;
            font-weight: normal;
        }

        .footer-info p {
            margin: 0;
            font-size: 12px;
            line-height: 1.4;
        }

        .footer-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .visits-counter {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .visits-label {
            background: white;
            color: #2c5282;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 14px;
        }

        .visits-number {
            background: #f7d322;
            color: #2c5282;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 14px;
        }

        .social-icons {
            display: flex;
            gap: 10px;
        }

        .social-icon {
            background: #1a365d;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .social-icon:hover {
            background: #155fa0;
        }

        .unach-logo {
            height: 50px;
            width: auto;
        }

        @media (max-width: 768px) {
            #Reporte #reporte-estaciones-container {
                flex-direction: column;
                align-items: center;
            }

            #Reporte .panel {
                max-width: 100%;
                min-width: 300px;
            }

            .footer-content {
                flex-direction: column;
                text-align: center;
            }

            .footer-right {
                flex-direction: column;
                gap: 15px;
            }

            .download-notification {
                right: 10px;
                left: 10px;
                min-width: auto;
            }

            #map {
                height: 400px;
            }

            .station-legend {
                gap: 15px;
            }
        }

         .subtab-nav {
             list-style: none;
             padding: 0;
             margin: 0 0 10px 0;
             display: flex;
             border-bottom: 2px solid #ccc;
         }

        .subtab-link {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #eee;
            border: 1px solid #ccc;
            border-bottom: none;
            margin-right: 5px;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }

        .subtab-link.active {
            background-color: #fff;
            font-weight: bold;
            border-bottom: 2px solid white;
        }

        .subtab-content {
            border: 1px solid #ccc;
            border-top: none;
            padding: 15px;
            background-color: #fff;
        }
    </style>
    <script>
        let visitCounter = 1543;
        let chartInstance = null;
        let graficasInstancias = {};

        function openTab(evt, tabName) {
            const contents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < contents.length; i++) {
                contents[i].style.display = "none";
            }
            const tabs = document.getElementsByClassName("tab");
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove("active");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.classList.add("active");

            if (tabName === 'Estaciones' && !window.mapInitialized) {
                setTimeout(initMap, 100);
            }
        }

        function abrirModal(id) {
            document.getElementById(id).style.display = 'block';
        }

        function cerrarModal(id) {
            document.getElementById(id).style.display = 'none';
        }



        function abrirModalGrafica(btn) {
            const estacion = btn.getAttribute("data-estacion");

            fetch(`/api/datosMensuales?estacion=${encodeURIComponent(estacion)}`)
                .then(res => res.json())
                .then(datos => {
                    const hoy = new Date();
                    const mesActual = hoy.getMonth();
                    const anioActual = hoy.getFullYear();

                    function parseFechaHora(fecha, hora) {
                        const partes = fecha.split(/[-/]/);
                        if (partes[0].length === 4) {
                            return new Date(`${fecha}T${hora}`);
                        } else {
                            let [dd, mm, yy] = partes;
                            if (yy.length === 2) yy = '20' + yy;
                            return new Date(`${yy}-${mm}-${dd}T${hora}`);
                        }
                    }

                    let datosFiltrados = datos.filter(d => {
                        const fechaHora = parseFechaHora(d.fecha, d.hora);
                        return fechaHora.getMonth() === mesActual &&
                            fechaHora.getFullYear() === anioActual;
                    });

                    if (datosFiltrados.length === 0) {
                        alert(`No hay datos disponibles para ${estacion} en el mes actual.`);
                        return;
                    }

                    if (datosFiltrados.length > 100) {
                        const factor = Math.ceil(datosFiltrados.length / 100);
                        datosFiltrados = datosFiltrados.filter((_, i) => i % factor === 0);
                    }

                    function parseDatoNumerico(valor) {
                        const val = parseFloat(valor);
                        return isNaN(val) ? null : val;
                    }
                    function normalizarAHora(fecha, hora) {
                        const dt = parseFechaHora(fecha, hora);
                        dt.setMinutes(0, 0, 0);
                        return dt;
                    }

                    const horasUnicas = new Set();
                    datosFiltrados.forEach(d => {
                        const dt = normalizarAHora(d.fecha, d.hora).toISOString().slice(0, 13); // YYYY-MM-DDTHH
                        horasUnicas.add(dt);
                    });

                    const horasOrdenadas = Array.from(horasUnicas)
                        .map(str => new Date(str + ':00:00.000Z'))
                        .sort((a, b) => a - b);

                    const fechas = horasOrdenadas.map(f =>
                        f.toLocaleDateString('es-ES', {
                            day: '2-digit',
                            month: 'short',
                            hour: '2-digit',
                            minute: '2-digit'
                        })
                    );

                    function mapearDatosPorHora(datos, extractor) {
                        const mapa = {};
                        datos.forEach(d => {
                            const clave = normalizarAHora(d.fecha, d.hora).toISOString().slice(0, 13); // clave: YYYY-MM-DDTHH
                            const valor = parseDatoNumerico(extractor(d));
                            mapa[clave] = valor;
                        });

                        return horasOrdenadas.map(hora => {
                            const clave = hora.toISOString().slice(0, 13);
                            return mapa.hasOwnProperty(clave) ? mapa[clave] : null;
                        });
                    }

                    const datosTemp = mapearDatosPorHora(datosFiltrados, d => d.temperatura);
                    const datosPresion = mapearDatosPorHora(datosFiltrados, d => d.presion);
                    const datosRate = mapearDatosPorHora(datosFiltrados, d => d.viento);
                    const datosHumedad = mapearDatosPorHora(datosFiltrados, d => d.humedad);
                    const datosAQI = mapearDatosPorHora(datosFiltrados, d => d.aqi);

                    console.log("Fechas:", fechas);
                    console.log("Temp con posibles nulls:", datosTemp);

                    Object.values(graficasInstancias).forEach(grafica => {
                        if (grafica) {
                            grafica.destroy();
                        }
                    });
                    graficasInstancias = {};

                    const modal = document.getElementById('modalReporte');
                    if (typeof bootstrap !== 'undefined') {

                        const modalInstance = new bootstrap.Modal(modal);
                        modalInstance.show();
                    } else if (typeof $ !== 'undefined') {
                        $(modal).modal('show');
                    } else {
                        modal.style.display = 'block';
                        modal.classList.add('show');
                        document.body.classList.add('modal-open');
                    }

                    setTimeout(() => {
                        try {
                            crearGrafica('graficaTemperatura', 'Temperatura (°C)', datosTemp, `Temperatura - ${estacion}`, fechas);
                            crearGrafica('graficaPresion', 'Presión (hPa)', datosPresion, `Presión - ${estacion}`, fechas);
                            crearGrafica('graficaRate', 'Viento (km/h)', datosRate, `Viento - ${estacion}`, fechas);
                            crearGrafica('graficaHumedad', 'Humedad (%)', datosHumedad, `Humedad - ${estacion}`, fechas);
                            crearGrafica('graficaAQI', 'Calidad del Aire (AQI)', datosAQI, `AQI - ${estacion}`, fechas);
                        } catch (error) {
                            console.error('Error al crear gráficas:', error);
                        }
                    }, 500);
                })
                .catch(err => {
                    alert(`Error al cargar datos de la estación ${estacion}`);
                    console.error(err);
                });
        }

        function redimensionarGraficas() {
            Object.values(graficasInstancias).forEach(grafica => {
                if (grafica) {
                    grafica.resize();
                }
            });
        }
        function debugGraficas() {
            console.log('Gráficas instanciadas:', Object.keys(graficasInstancias));
            console.log('Chart.js versión:', Chart.version);

            const canvasIds = ['graficaTemperatura', 'graficaPresion', 'graficaRate', 'graficaHumedad', 'graficaAQI'];
            canvasIds.forEach(id => {
                const canvas = document.getElementById(id);
                console.log(`Canvas ${id}:`, canvas ? 'Existe' : 'No existe');
            });
        }

        window.addEventListener('resize', redimensionarGraficas);
        window.debugGraficas = debugGraficas;


        function initMap() {
            if (window.mapInitialized) return;

            const tuxtlaCoords = [16.7533, -93.1132];
            const map = L.map('map').setView(tuxtlaCoords, 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);


            fetch("/api/estacion")
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log("Datos recibidos del API:", data);

                     let estaciones = [];
                    if (Array.isArray(data)) {
                        estaciones = data;
                    } else if (data && typeof data === 'object') {
                        estaciones = data.estaciones || data.data || [data];
                    }

                    console.log("Estaciones procesadas:", estaciones);

                    if (estaciones.length === 0) {
                        console.warn("No se encontraron estaciones para mostrar");
                        return;
                    }

                    estaciones.forEach((estacion, index) => {
                        console.log(`Procesando estación ${index}:`, estacion);

                        const lat = parseFloat(estacion.latitud || estacion.lat);
                        const lng = parseFloat(estacion.longitud || estacion.lng || estacion.lon);

                        if (isNaN(lat) || isNaN(lng)) {
                            console.warn(`Estación ${estacion.nombre || index} tiene coordenadas inválidas:`, {lat, lng});
                            return;
                        }

                        let isActive = false;
                        if (estacion.activa !== undefined) {
                            isActive = estacion.activa;
                        } else if (estacion.fechaHora) {
                            const now = new Date();
                            const estacionTime = new Date(estacion.fechaHora);
                            const diffMinutes = (now - estacionTime) / (1000 * 60);
                            isActive = diffMinutes <= 30;
                        } else {
                            isActive = false;
                        }

                        const iconColor = isActive ? '#28a745' : '#dc3545';
                        const icon = L.divIcon({
                            html: `<div style="
                        background-color: ${iconColor};
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 3px 8px rgba(0,0,0,0.4);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 12px;
                    ">📡</div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12],
                            popupAnchor: [0, -12],
                            className: 'custom-station-icon'
                        });

                        const marker = L.marker([lat, lng], { icon: icon }).addTo(map);

                        const popupContent = `
                    <div style="min-width: 220px; font-family: 'Segoe UI', sans-serif;">
                        <h3 style="margin: 0 0 12px 0; color: #155fa0; font-size: 16px; text-align: center;">
                            ${estacion.nombre || 'Estación Sin Nombre'}
                        </h3>
                        <div style="margin: 8px 0; padding: 6px; background: ${isActive ? '#d4edda' : '#f8d7da'}; border-radius: 4px; text-align: center;">
                            <strong>Estado:</strong>
                            <span style="color: ${isActive ? '#155724' : '#721c24'}; font-weight: bold;">
                                ${isActive ? '🟢 Activa' : '🔴 Inactiva'}
                            </span>
                        </div>
                       <div style="font-size: 13px; line-height: 1.4;">
    <p style="margin: 4px 0; color: ${estacion.temperatura === 0 ? '#999' : '#000'};">
        <strong>🌡️ Temperatura:</strong> ${(typeof estacion.temperatura === 'number' && !isNaN(estacion.temperatura)) ? estacion.temperatura.toFixed(1) + '°C' : 'N/A'}
    </p>
    <p style="margin: 4px 0; color: ${estacion.presion === 0 ? '#999' : '#000'};">
        <strong>📊 Presión:</strong> ${(typeof estacion.presion === 'number' && !isNaN(estacion.presion)) ? estacion.presion.toFixed(1) + ' hPa' : 'N/A'}
    </p>
    <p style="margin: 4px 0; color: ${estacion.humedad === 0 ? '#999' : '#000'};">
        <strong>💧 Humedad:</strong>
        ${(typeof estacion.humedad === 'number' && !isNaN(estacion.humedad))
                            ? (estacion.humedad === 0 ? 'Sin humedad' : estacion.humedad.toFixed(1) + '%')
                            : 'N/A'}
    </p>
    <p style="margin: 4px 0; color: ${estacion.viento === 0 ? '#999' : '#000'};">
        <strong>💨 Viento:</strong>
        ${(typeof estacion.viento === 'number' && !isNaN(estacion.viento))
                            ? (estacion.viento === 0 ? 'Sin viento' : estacion.viento.toFixed(1) + ' km/h')
                            : 'N/A'}
    </p>
    ${
                            (typeof estacion.aqi === 'number' && !isNaN(estacion.aqi))
                                ? `<p style="margin: 4px 0; color: ${estacion.aqi === 0 ? '#999' : '#000'};">
            <strong>🌬️ AQI:</strong> ${estacion.aqi === 0 ? 'Sin contaminación' : estacion.aqi}
          </p>`
                                : ''
                        }
</div>
<div style="margin-top: 8px; font-size: 11px; color: #666; text-align: center;">
    ${estacion.descripcion || "Sistema Meteorológico Avispero"}
</div>


                    </div>`;

                        marker.bindPopup(popupContent, {
                            maxWidth: 250,
                            className: 'custom-popup'
                        });

                        marker.on('mouseover', function() {
                            this.openPopup();
                        });
                    });

                    const cityIcon = L.divIcon({
                        html: `<div style="
                    font-size: 24px;
                    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
                    filter: drop-shadow(0 0 3px rgba(255,255,255,0.8));
                ">🏛️</div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15],
                        className: 'city-icon'
                    });

                    L.marker(tuxtlaCoords, { icon: cityIcon }).addTo(map)
                        .bindPopup(`
                    <div style="text-align: center; min-width: 200px;">
                        <h3 style="margin: 0 0 8px 0; color: #155fa0;">Tuxtla Gutiérrez</h3>
                        <p style="margin: 0; font-size: 13px; color: #666;">Capital del estado de Chiapas</p>

                    </div>
                `);

                    if (estaciones.length > 0) {
                        const group = new L.featureGroup(map._layers);
                        if (Object.keys(group._layers).length > 0) {
                            map.fitBounds(group.getBounds().pad(0.1));
                        }
                    }

                    window.mapInitialized = true;
                    console.log("Mapa inicializado correctamente con", estaciones.length, "estaciones");
                })
                .catch(error => {
                    console.error("Error al cargar datos de estaciones:", error);

                    const errorPopup = L.popup()
                        .setLatLng(tuxtlaCoords)
                        .setContent(`
                    <div style="text-align: center; color: #dc3545;">
                        <h3>⚠️ Error al cargar estaciones</h3>
                        <p>No se pudieron cargar los datos de las estaciones meteorológicas.</p>
                        <p style="font-size: 12px;">Error: ${error.message}</p>
                    </div>
                `)
                        .openOn(map);

                    window.mapInitialized = true;
                });
        }

        function actualizarMapa() {
            if (window.mapInitialized) {
                window.mapInitialized = false;
                const mapContainer = document.getElementById('map');
                if (mapContainer._leaflet_id) {
                    mapContainer._leaflet_id = null;
                }
                mapContainer.innerHTML = '';
                initMap();
            }
        }

        function openTab(evt, tabName) {
            const contents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < contents.length; i++) {
                contents[i].style.display = "none";
            }
            const tabs = document.getElementsByClassName("tab");
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove("active");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.classList.add("active");

            if (tabName === 'Estaciones') {
                setTimeout(() => {
                    if (!window.mapInitialized) {
                        console.log("Inicializando mapa...");
                        initMap();
                    } else {
                        console.log("Mapa ya inicializado");

                        const map = window.mapInstance;
                        if (map) {
                            map.invalidateSize();
                        }
                    }
                }, 300);
            }
        }
    </script>
</head>
<body>


<header>
    <div style="display: flex; align-items: center; background-color: rgba(179,134,0,0); padding: 10px;">
        <img src="/img/simeavfc.png" alt="Logo SiMeAv" style="height: 70px; margin-right: 30px;">
        <div style="line-height: 1.2; margin-top: -5px;">
            <h1 style="margin: 0; font-size: 20px; color: white;">SISTEMA METEOROLÓGICO AVISPERO</h1>
            <h2 style="margin: 0; font-size: 18px; color: white;">FACULTAD DE CIENCIAS EN FÍSICAS Y MATEMÁTICAS</h2>
        </div>
    </div>

</header>


<nav>
    <div class="tab" id="defaultTab" onclick="openTab(event, 'Inicio')">INICIO</div>
    <div class="tab" onclick="openTab(event, 'Reporte')">REPORTE POR ESTACIÓN</div>
    <div class="tab" onclick="openTab(event, 'Estaciones')">ESTACIONES</div>
    <div class="tab" onclick="openTab(event, 'Escaramujo')">ESCARAMUJO</div>
</nav>
<main>
    <div id="Inicio" class="tab-content">
        <div class="subtabs">
            <ul class="subtab-nav">
                <li th:each="entry, iter : ${datosPorEstacion.entrySet()}"
                    th:with="estacion=${entry.key}"
                    th:id="${iter.index == 0} ? 'defaultTab' : null"
                    th:classappend="${iter.index == 0} ? 'active' : ''"
                    class="subtab-link"
                    th:attr="onclick=|openSubTab(event, '${#strings.replace(#strings.replace(estacion, '/', '_'), ' ', '_')}')|"
                    th:text="${nombresAmigables[entry.value.region] ?: entry.value.region}">Estación</li>
            </ul>

            <div th:each="entry, iter : ${datosPorEstacion.entrySet()}"
                 th:with="estacion=${entry.key}"
                 th:id="${#strings.replace(#strings.replace(estacion, '/', '_'), ' ', '_')}"
                 class="subtab-content"
                 th:style="${iter.index == 0} ? 'display:block;' : 'display:none;'">

                <div class="panel">
                    <h2 th:text="${nombresAmigables[entry.value.region] ?: entry.value.region}">Nombre Estación</h2>

                    <div class="status-indicator"
                         th:if="${entry.value.fechaHora != null}"
                         th:text="${entry.value.fechaHora.isAfter(T(java.time.ZonedDateTime).now(T(java.time.ZoneId).of('America/Mexico_City')).toLocalDateTime().minusMinutes(30))} ? '● Activa' : '● Inactiva'"
                         th:classappend="${entry.value.fechaHora.isAfter(T(java.time.ZonedDateTime).now(T(java.time.ZoneId).of('America/Mexico_City')).toLocalDateTime().minusMinutes(30))} ? 'status-activa' : 'status-inactiva'">
                    </div>
                    <div class="status-indicator status-inactiva" th:unless="${entry.value.fechaHora != null}">
                        ● Sin datos
                    </div>

                    <div class="fecha">
                        <span th:text="${entry.value.fecha != null ? entry.value.fecha : '--'}">--</span>
                    </div>
                    <div class="hora">
                        <span th:text="${entry.value.hora != null ? entry.value.hora : '--'}">--</span>
                    </div>

                    <div class="main-weather">
                        <span th:utext="${entry.value.estadoClima != null ? entry.value.estadoClima : '☀️'}">☀️</span>
                        <span th:text="${entry.value.temperatura != null ? #numbers.formatDecimal(entry.value.temperatura, 0, 0) : '--'}">--</span>° C
                    </div>

                    <div class="data-boxes">
                        <div class="data-box">
                            <strong>Presión</strong>
                            <span th:text="${entry.value.presion != null ? #numbers.formatDecimal(entry.value.presion, 0, 0) : '--'}">--</span> hPa
                        </div>

                        <div class="data-box">
                            <strong>Humedad</strong>
                            <span th:text="${entry.value.humedad != null ? #numbers.formatDecimal(entry.value.humedad, 0, 0) : '--'}">--</span> %
                        </div>

                        <div class="data-box">
                            <strong>Velocidad del viento</strong>
                            <span th:text="${entry.value.viento != null ? #numbers.formatDecimal(entry.value.viento, 0, 0) : '--'}">--</span> km/h
                        </div>

                        <div class="data-box">
                            <strong>AQI</strong>
                            <span class="aqi-textual"
                                  th:with="aqi=${entry.value.aqi}"
                                  th:text="${aqi != null ? (aqi <= 50 ? 'Bueno' : (aqi <= 100 ? 'Regular' : 'Malo')) : '--'}">
</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openSubTab(evt, tabId) {
            const contents = document.querySelectorAll('#Inicio .subtab-content');
            contents.forEach(c => c.style.display = 'none');

            const tabs = document.querySelectorAll('#Inicio .subtab-link');
            tabs.forEach(t => t.classList.remove('active'));

            const target = document.getElementById(tabId);
            if (target) {
                target.style.display = 'block';
                console.log('Mostrando tab:', tabId);
            } else {
                console.error('No se encontró el tab:', tabId);
            }

            evt.currentTarget.classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const defaultTab = document.getElementById('defaultTab');
            if (defaultTab) {
                defaultTab.click();
                console.log('Tab por defecto activado');
            } else {
                console.error('No se encontró el tab por defecto');
            }
        });
    </script>

    <div id="Reporte" class="tab-content">
        <div class="subtabs">
            <ul class="subtab-nav">
                <li th:each="region, iter : ${datosPorRegion.keySet()}"
                    th:id="${iter.index == 0} ? 'defaultTabReporte' : null"
                    th:classappend="${iter.index == 0} ? 'active' : ''"
                    class="subtab-link"
                    th:attr="onclick=|openSubTabReporte(event, '${region}')|"
                    th:text="${nombresAmigables[region] ?: region}">Región</li>
            </ul>

            <div th:each="regionEntry, iter : ${datosPorRegion.entrySet()}"
                 th:id="'reporte_' + ${regionEntry.key}"
                 class="subtab-content"
                 th:style="${iter.index == 0} ? 'display:flex; flex-wrap:wrap; justify-content:center;' : 'display:none; flex-wrap:wrap; justify-content:center;'"
                 style="gap: 1rem;">

                <div th:each="dato : ${regionEntry.value}" class="panel" style="width: 320px; margin: 1rem;">
                     <h2 th:text="${nombresAmigablesEstaciones[dato.estacion] ?: dato.estacion}">Nombre Estación</h2>

                    <div class="status-indicator"
                         th:if="${dato.fechaHora != null}"
                         th:text="${dato.fechaHora.isAfter(T(java.time.ZonedDateTime).now(T(java.time.ZoneId).of('America/Mexico_City')).toLocalDateTime().minusMinutes(30))} ? '● Activa' : '● Inactiva'"
                         th:classappend="${dato.fechaHora.isAfter(T(java.time.ZonedDateTime).now(T(java.time.ZoneId).of('America/Mexico_City')).toLocalDateTime().minusMinutes(30))} ? 'status-activa' : 'status-inactiva'">
                    </div>
                    <div class="status-indicator status-inactiva" th:unless="${dato.fechaHora != null}">
                        ● Sin datos
                    </div>

                    <div class="fecha"><span th:text="${dato.fecha != null ? dato.fecha : '--'}">--</span></div>
                    <div class="hora"><span th:text="${dato.hora != null ? dato.hora : '--'}">--</span></div>

                    <div class="main-weather">
                        <span th:utext="${dato.estadoClima != null ? dato.estadoClima : '☀️'}">☀️</span>
                        <span th:text="${dato.temperatura != null ? #numbers.formatDecimal(dato.temperatura, 0, 0) : '--'}">--</span>° C
                    </div>

                    <div class="data-boxes">
                        <div class="data-box">
                            <strong>Temperatura</strong>
                            <span th:text="${dato.temperatura != null ? #numbers.formatDecimal(dato.temperatura, 0, 2) : '--'}">--</span>° C
                        </div>
                        <div class="data-box">
                            <strong>Presión</strong>
                            <span th:text="${dato.presion != null ? #numbers.formatDecimal(dato.presion, 0, 4) : '--'}">--</span> hPa
                        </div>
                        <div class="data-box">
                            <strong>Humedad</strong>
                            <span th:text="${dato.humedad != null ? #numbers.formatDecimal(dato.humedad, 0, 1) : '--'}">--</span> %
                        </div>
                        <div class="data-box">
                            <strong>Velocidad del viento</strong>
                            <span th:text="${dato.viento != null ? #numbers.formatDecimal(dato.viento, 0, 2) : '--'}">--</span> km/h
                        </div>
                        <div class="data-box">
                            <strong>AQI</strong>
                            <span th:text="${dato.aqi != null ? dato.aqi : '--'}">--</span>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn"
                                th:attr="data-estacion=${dato.estacion}, data-fechainicio=${fechaMin}, data-fechafin=${fechaMax}"
                                onclick="descargarCSV(this)">
                            📥 Descargar CSV
                        </button>
                        <button class="btn"
                                th:attr="data-estacion=${dato.estacion}"
                                onclick="abrirModalGrafica(this)">
                            📊 Ver Gráfica
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openSubTabReporte(evt, regionId) {
            const contents = document.querySelectorAll('#Reporte .subtab-content');
            contents.forEach(c => c.style.display = 'none');

            const tabs = document.querySelectorAll('#Reporte .subtab-link');
            tabs.forEach(t => t.classList.remove('active'));

            const target = document.getElementById('reporte_' + regionId);
            if (target) {
                target.style.display = 'flex';
                target.style.flexWrap = 'wrap';
                target.style.justifyContent = 'center';
                console.log('Mostrando reporte:', regionId);
            } else {
                console.error('No se encontró el reporte:', regionId);
            }

            evt.currentTarget.classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const defaultTabReporte = document.getElementById('defaultTabReporte');
            if (defaultTabReporte) {
                defaultTabReporte.click();
                console.log('Tab de reporte por defecto activado');
            }
        });
    </script>

    <div id="Estaciones" class="tab-content">
        <div class="panel">
            <h2>MAPA DE ESTACIONES METEOROLÓGICAS</h2>

            <div class="station-legend">
                <div class="legend-item">
                    <div class="legend-dot active"></div>
                    <span>Estación Activa</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot inactive"></div>
                    <span>Estación Inactiva</span>
                </div>
            </div>

            <div id="map"></div>
            <div class="map-info">
                <h3>Información del Sistema</h3>
                <p>El Sistema Meteorológico Avispero cuenta con estaciones distribuidas estratégicamente en la región de Tuxtla Gutiérrez, Chiapas.
                    Cada estación recolecta datos de temperatura, presión, humedad, velocidad del viento e indice de calidad del aire, estos parámetros meteorológicos son importantes para
                    el monitoreo climático de la región.</p>
                <p><strong>Haz clic en los marcadores del mapa</strong> para ver información detallada de cada estación meteorológica.</p>
            </div>
        </div>
    </div>

    <div id="Escaramujo" class="tab-content">
        <div class="panel">
            <h2 style="text-align: center; color: #000000;">ESCARAMUJO: SEMBRANDO CIENCIA EN TIERRAS LATINOAMERICANAS</h2>

            <p style="text-align: justify; color: #000000;">
                El <strong>Proyecto Escaramujo</strong> es una iniciativa educativa de divulgación científica en Latinoamérica, enfocada en la instrumentación en Física de Altas Energías y Astropartículas.
                El físico <strong>Federico Izraelevitch</strong>, acompañado de su familia, recorrió el continente desde Chicago hasta Buenos Aires en camioneta, impartiendo cursos prácticos en universidades de países como
                México, Guatemala, Costa Rica, Colombia, Ecuador, Perú, Bolivia, Brasil, Paraguay y Argentina.
            </p>

            <p style="text-align: justify; color: #000000;">
                El detector Escaramujo reportado en este servicio se encuentra ubicado en la <strong>Facultad de Ciencias en Física y Matemáticas</strong> de la Universidad Autónoma de Chiapas,
                integrando sensores adicionales para el registro de <strong>presión</strong> y <strong>temperatura</strong>, conectados directamente al hardware del sistema.
            </p>

            <p style="text-align: justify; color: #000000;">
                El dispositivo consta de placas de plástico centellador conectadas a Fotomultiplicadores de Silicio. La lectura se realiza a través de una placa <strong>TDC Quarknet</strong>,
                y la digitalización de los datos se lleva a cabo mediante un sistema <strong>Raspberry Pi</strong>.
            </p>

            <div style="text-align: center; margin: 20px 0;">
                <img src="/img/Escaramujo.png" alt="Detector Escaramujo" style="max-width: 70%; height: auto; border-radius: 10px;">
                <p style="font-size: 13px; color: #555;">Figura: Detector Escaramujo instalado en Ciudad Universitaria UNACH</p>
            </div>

        </div>
    </div>



    <footer>
        <div class="footer-content">
            <div class="footer-left">
                <div class="footer-info">
                    <h3>Universidad Autónoma de Chiapas</h3>
                    <p>Carretera Emiliano Zapata Km 8.0, Rancho San Francisco, Ciudad Universitaria, Terán,<br>
                        Tuxtla Gutiérrez, Chiapas, 29050<br>
                    </p>
                </div>
            </div>
            <div class="footer-right">
                <div class="visits-counter">

                </div>
                <svg width="360" height="100" viewBox="0 0 360 100" xmlns="http://www.w3.org/2000/svg">

                    <text x="50" y="60" font-family="Georgia, serif" font-size="30" fill="white" letter-spacing="1.5">UNACH</text>

                    <line x1="180" y1="20" x2="180" y2="80" stroke="white" stroke-width="1"/>

                    <text x="190" y="40" font-family="Georgia, serif" font-size="16" fill="white">Universidad</text>
                    <text x="190" y="60" font-family="Georgia, serif" font-size="16" fill="white">Autónoma</text>
                    <text x="190" y="80" font-family="Georgia, serif" font-size="16" fill="white">de Chiapas</text>
                </svg>



            </div>
        </div>
    </footer>
    <div id="modalDescargar" style="display: none;">
        <div class="modal-content" style="background: #fff; padding: 20px; border-radius: 10px; max-width: 400px; margin: auto; margin-top: 50px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Descargar Datos CSV</h3>
                <button class="close-btn" onclick="cerrarModal('modalDescargar')" style="font-size: 20px;">&times;</button>
            </div>
            <form onsubmit="iniciarDescarga(event)">
                <input type="hidden" id="modalEstacion" name="estacion">
                <label for="fechaInicio">Desde:</label><br>
                <input type="date" id="fechaInicio" name="fechaInicio" required><br><br>
                <label for="fechaFin">Hasta:</label><br>
                <input type="date" id="fechaFin" name="fechaFin" required><br><br>
                <button class="btn" type="submit">Descargar</button>
                <button type="button" class="btn" style="background-color: gray; margin-left: 10px;" onclick="cerrarModal('modalDescargar')">Cancelar</button>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        window.minFechaDisponible = /*[['${fechaMin}']]*/ '2025-07-25';


        function mostrarNotificacion(mensaje, tipo = 'info') {

            const notificacion = document.createElement('div');
            notificacion.textContent = mensaje;
            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${tipo === 'success' ? '#4CAF50' : '#2196F3'};
                color: white;
                padding: 12px 24px;
                border-radius: 4px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                transition: opacity 0.3s ease;
            `;

            document.body.appendChild(notificacion);


            setTimeout(() => {
                notificacion.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(notificacion)) {
                        document.body.removeChild(notificacion);
                    }
                }, 300);
            }, 3000);
        }

        function abrirModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.style.display = 'block';
        }

        function cerrarModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.style.display = 'none';
        }

        function descargarCSV(btn) {
            const estacion = btn.getAttribute("data-estacion");
            const fechaInicio = btn.getAttribute("data-fechainicio");
            const fechaFin = btn.getAttribute("data-fechafin");

            document.getElementById("modalEstacion").value = estacion;
            document.getElementById("fechaInicio").value = fechaInicio;
            document.getElementById("fechaFin").value = fechaFin;

            abrirModal("modalDescargar");
        }

        function iniciarDescarga(event) {
            event.preventDefault();

            const estacion = document.getElementById("modalEstacion").value;
            const fechaInicio = document.getElementById("fechaInicio").value;
            const fechaFin = document.getElementById("fechaFin").value;

            if (!fechaInicio || !fechaFin || !estacion) {
                alert("Por favor completa todos los campos.");
                return;
            }

            const inicio = new Date(fechaInicio);
            const fin = new Date(fechaFin);
            const minFecha = new Date(window.minFechaDisponible);

            if (inicio < minFecha) {
                alert("No hay datos disponibles para la fecha " + fechaInicio +
                    ". El primer dato disponible es del " + window.minFechaDisponible + ".");
                return;
            }

            if (inicio > fin) {
                alert("La fecha de inicio no puede ser mayor que la de fin.");
                return;
            }

            mostrarNotificacion("Descargando CSV...", 'info');

            const url = `/descargarCSV?estacion=${encodeURIComponent(estacion)}&fechaInicio=${encodeURIComponent(fechaInicio)}&fechaFin=${encodeURIComponent(fechaFin)}`;

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error("Error al descargar el archivo");
                    return response.blob();
                })
                .then(blob => {
                    const urlBlob = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = urlBlob;
                    link.download = `datos_${estacion}.csv`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(urlBlob);

                    mostrarNotificacion("Archivo CSV descargado", 'success');

                    cerrarModal("modalDescargar");
                })
                .catch(error => {
                    console.error("Error al descargar CSV:", error);
                    alert("No se pudo descargar el archivo CSV.");
                });
        }
    </script>


    <div id="modalReporte">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Reporte Mensual - FCFM</h3>
                <button class="close-btn" aria-label="Cerrar" onclick="cerrarModal('modalReporte')">&times;</button>
            </div>
            <canvas id="graficaTemperatura"></canvas>
            <canvas id="graficaPresion"></canvas>
            <canvas id="graficaRate"></canvas>
            <canvas id="graficaHumedad"></canvas>
            <canvas id="graficaAQI"></canvas>
        </div>
    </div>
    <div th:if="${error}" style="color: red; font-weight: bold;">
        <p th:text="${error}"></p>
    </div>


</main>
<script>
    window.addEventListener("load", function () {
        document.getElementById("defaultTab").click();
    });
</script>
<script>
    function crearGrafica(canvasId, label, data, titulo, etiquetas) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) {
            console.error('Canvas no encontrado:', canvasId);
            return;
        }

        canvas.width = 400;
        canvas.height = 300;

        const ctx = canvas.getContext('2d');

        if (graficasInstancias[canvasId]) {
            graficasInstancias[canvasId].destroy();
        }

        graficasInstancias[canvasId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: etiquetas,
                datasets: [{
                    label: label,
                    data: data,
                    borderColor: '#155fa0',
                    backgroundColor: 'rgba(21,95,160,0.1)',
                    tension: 0.1,
                    fill: false,
                    spanGaps: false,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: {
                    title: {
                        display: true,
                        text: titulo,
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Tiempo'
                        },
                        ticks: {
                            maxTicksLimit: 6,
                            maxRotation: 45
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: label
                        },
                        beginAtZero: false
                    }
                }
            }
        });

        console.log('Gráfica creada:', canvasId);
    }

</script>


</body>
</html>